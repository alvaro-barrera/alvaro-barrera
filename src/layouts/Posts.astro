---
import Layout from "@layouts/Layout.astro";
import Main from "@layouts/Main.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import Card from "@components/Card";
import { SITE } from "@config";
import type { Page } from "astro";
import type { CollectionEntry } from "astro:content";
import getUniqueTags from "@utils/getUniqueTags";
import { getCollection } from "astro:content";
import Tag from "@components/Tag.astro";
import getPostsByGroupCondition from "@utils/getPostsByGroupCondition";

export interface Props {
  page: Page<CollectionEntry<"blog">>;
}

const { page } = Astro.props;
const posts = await getCollection("blog");

let tags = getUniqueTags(posts);

const MonthMap: Record<string, string> = {
  "1": "Enero",
  "2": "Febrero",
  "3": "Marzo",
  "4": "Abril",
  "5": "Mayo",
  "6": "Junio",
  "7": "Julio",
  "8": "Agosto",
  "9": "Septiembre",
  "10": "Octubre",
  "11": "Noviembre",
  "12": "Diciembre",
};
---

<Layout title={`Blog | ${SITE.title}`}>
  <Header activeNav="posts" />
  <Main pageTitle="Blog" pageDesc="Todos los artÃ­culos">
    <ul>
      {tags.map(({ tag }) => <Tag {tag} size="sm" />)}
    </ul>
    <br />

    <ul>
      {
        Object.entries(
          getPostsByGroupCondition(posts, post =>
            post.data.pubDatetime.getFullYear()
          )
        )
          .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
          .map(([year, yearGroup]) => (
            <div>
              <span class="text-2xl font-bold">{year}</span>
              <sup class="text-sm">{yearGroup.length}</sup>
              {Object.entries(
                getPostsByGroupCondition(
                  yearGroup,
                  post => post.data.pubDatetime.getMonth() + 1
                )
              )
                .sort(([monthA], [monthB]) => Number(monthB) - Number(monthA))
                .map(([month, monthGroup]) => (
                  <div class="flex flex-col sm:flex-row">
                    <div class="mt-6 min-w-36 text-lg sm:my-6">
                      <span class="font-bold">{MonthMap[month]}</span>
                      <sup class="text-xs">{monthGroup.length}</sup>
                    </div>
                    <ul>
                      {monthGroup.map(({ data, slug }) => (
                        <Card href={`/posts/${slug}`} frontmatter={data} />
                      ))}
                    </ul>
                  </div>
                ))}
            </div>
          ))
      }
    </ul>
  </Main>

  <Footer noMarginTop={page.lastPage > 1} />
</Layout>
